# 更新日志

## v1.3.6

- **[新增] 全局 FIFO 请求队列**：TTS 请求改为严格先到先得，后到请求不会插队。
- **[优化] 队列工作器与退出清理**：新增请求调度 worker；插件卸载时会停止 worker 并清空未处理请求，避免遗留等待任务。
- **[优化] 长文本并发 worker 数量**：句子切分合成时，worker 数量限制为 `min(文本块数, 服务器数)`，减少空闲协程占用。

## v1.3.5

- **[新增] TTS 文本清洗配置**：新增 `enable_tts_text_cleaning` 与 `tts_text_clean_regex`，支持在发送 TTS 前按正则清洗文本（默认关闭）。
- **[修复] LLM 翻译标签提取误匹配**：仅在开启 LLM 翻译注入时提取翻译标签，并限制为显式结尾标记（`$...$`/`＄...＄`），避免误删普通文本中的路径、金额等内容。
- **[修复] 翻译异常二次报错**：修复翻译请求早期失败时 `response` 未定义导致的异常分支崩溃问题。
- **[修复] 插件卸载后台任务泄漏**：插件卸载时会主动停止 TTS 引擎清理协程，避免热重载后残留任务。
- **[优化] 嵌套括号清洗稳定性**：提高清洗轮数，改善深层嵌套括号文本的清洗效果。

## v1.3.4

- **【新增】群组白名单**：新增 `群组白名单` 配置项，白名单中的群组将在 Bot 启动时自动开启全局语音合成（无需手动执行 `/ttg` 指令）。
- **【新增】群组黑名单**：新增 `群组黑名单` 配置项，黑名单中的群组将完全禁用语音合成的所有功能和指令。
- **【说明】优先级**：如果某群组同时出现在白名单和黑名单中，黑名单优先（安全考虑）。

## v1.3.3
> [!IMPORTANT]
> **Hugging Face Space 需要重新部署**：本版本修复了后端 genie-tts 的兼容性问题。**请使用最新的 `Dockerfile` 和 `app.py` 重新复制/部署您的 Space**，否则中文 TTS 可能无法正常工作。

- **【修复】后端模型加载**：修复了 genie-tts 2.0.2 与 HuggingFace 模型仓库的兼容问题，中文合成现已正常工作。
- **【新增】翻译开关**：新增 `启用翻译功能` 配置项。如果您使用的是中文模型，可关闭此选项直接使用原文，无需翻译。
- **【新增】超时配置**：新增 `TTS 超时时间` 配置项（默认 120 秒），支持自定义单次 TTS 请求的超时时间。
- **【优化】配置界面**：重新组织配置页面，使用 emoji 分类，更加清晰美观。
- **【优化】Worker 优化**：并行合成时，Worker 数量现在取 min(服务器数, 文本块数)，避免创建多余的空闲 Worker。

## v1.3.2
- **【修复】后端兼容性**：修复了因新版 API 变更导致插件无法访问后端的问题（缺少 `language` 参数）。
- **【新增】多语言支持**：新增 `tts_default_language` 配置项，允许设置 TTS 默认语言（默认为 `jp`），支持 `jp`, `zh`, `en`。
- **【新增】语言注册**：`/注册感情` 指令现在支持可选的语言参数，允许为特定的感情单独指定语言（如 `zh`, `en`），未指定则使用默认配置。

<details>
<summary>历史更新日志</summary>

## v1.3.1
- **【优化】提示词增强**：默认注入的提示词增加了 Markdown 标题 (`##`)，提升了 LLM 遵循指令的稳定性。
- **【优化】容错性提升**：增强了对全角符号 (`＄`) 的兼容性，并增加了对 LLM 幻觉报错的自动清理机制。

## v1.3.0
- **【新增】群组语音模式**：新增 `/ttg` 指令，可开启群组级语音合成，对群内所有成员生效。
- **【新增】LLM 情感注入**：支持让主 LLM 直接生成情感标签（格式 `[emotion=xxx]`），比旧版插件单独分析更精准。
- **【新增】LLM 直接翻译**：支持让主 LLM 直接生成日语翻译（格式 `$xxx$`），省去额外翻译 API 调用。
- **【新增】框架模型翻译**：支持直接调用 AstrBot 框架内配置的模型进行翻译，无需在插件中重复配置 Key。
- **【优化】配置升级**：新增"LLM 注入与高级翻译设置"配置区，支持自定义注入提示词。

## v1.2.2
- **【优化】保活机制**：现在支持同时对所有配置的 TTS 服务器进行保活，并可额外配置独立的保活地址。
- **【优化】缓存自动清理**：新增自动清理任务，每小时清理一次超过 30 分钟的临时音频文件，防止磁盘占用过大。
- **【优化】健壮性提升**：优化了保活任务的异常处理，防止任务意外终止。

## v1.2.0
- **【新增】长文本快速合成模式**：在配置中增加"句子切分"开关。开启后，插件会将长回复切分成短句，并行发送给多个TTS服务器合成，最后拼接成一条语音，显著提高长文本的响应速度。
- **【优化】代码结构重构**：将插件代码按功能模块化拆分为多个文件，提升了代码的可读性和可维护性。

## v1.1.0
- **【新增】自动情感识别模式**：加入 `/tts-w` 指令，可调用 LLM 分析文本情感，并自动匹配最合适的已注册声音进行合成。
- **【新增】配套指令**：加入 `/sw-w` 用于在自动模式下切换角色，以及 `/tts-w-q` 用于单独关闭自动模式。
- **【优化】配置体验**：将 WebUI 中的"TTS 服务器地址列表"从手动输入 JSON 字符串改为更方便的列表形式，可轻松增删地址。
- **【优化】提示词可配置**：将自动情感识别模式的提示词移入配置文件，方便用户自定义。
- **【调整】指令逻辑**：`/tts-q` 现在会关闭所有语音合成模式。

</details>
